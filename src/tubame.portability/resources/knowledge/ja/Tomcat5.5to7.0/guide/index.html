<HTML xmlns:knowhow="http://generated.model.biz.knowhow.tubame/knowhow" xmlns:doc="http://docbook.org/ns/docbook">
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>TomcatMigration5to7_ja</title>
<link href="css/knowhow.css" type="text/css" rel="stylesheet">
<script type="text/javascript" src="js/prettify.js"></script>
<meta content="DocBook XSL Stylesheets V1.78.1" name="generator">
</HEAD>
<BODY>
<H1 class="title">TomcatMigration5to7_ja</H1>
<div class="toc">
<p>
<b>Index</b>
</p>
<dl class="toc">
<dt>
<span class="1."><a href="#tubame_1.">1.JavaSE6必須</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="1.1."><a href="#tubame_1.1.">1.1.JavaSE6必須</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="2."><a href="#tubame_2.">2.JavaEE6必須</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="2.1."><a href="#tubame_2.1.">2.1.仕様サポート</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="2.2."><a href="#tubame_2.2.">2.2.Servlet 3.0 API</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="2.3."><a href="#tubame_2.3.">2.3.JavaEE非推奨API</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="2.3.1."><a href="#tubame_2.3.1.">2.3.1.Servlet非推奨API</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="2.3.2."><a href="#tubame_2.3.2.">2.3.2.JSP非推奨API</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="2.3.3."><a href="#tubame_2.3.3.">2.3.3.Servlet、JSP以外の非推奨API</a></span>
</dt>
</dl>
</dd>
</dl>
</dd>
<dt>
<span class="3."><a href="#tubame_3.">3.Servlet仕様への対応</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="3.1."><a href="#tubame_3.1.">3.1.Request属性</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="3.2."><a href="#tubame_3.2.">3.2.conf/web.xmlファイル処理</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="3.3."><a href="#tubame_3.3.">3.3.Welcomeファイル処理</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="3.4."><a href="#tubame_3.4.">3.4.アノテーション・スキャン</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="4."><a href="#tubame_4.">4.コンフィギュレーションの変更</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="4.1."><a href="#tubame_4.1.">4.1.Connectorの仕様変更</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="4.1.1."><a href="#tubame_4.1.1.">4.1.1.SSL設定</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.1.2."><a href="#tubame_4.1.2.">4.1.2.スレッドプール</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.1.3."><a href="#tubame_4.1.3.">4.1.3.コネクタとスレッドプール</a></span>
</dt>
</dl>
</dd>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.2."><a href="#tubame_4.2.">4.2.クラスタリングのコンフィグレーションの変更</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="4.2.1."><a href="#tubame_4.2.1.">4.2.1.クラスタリング構成のサーバ設定</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.2.2."><a href="#tubame_4.2.2.">4.2.2.ThroughputInterceptor</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.2.3."><a href="#tubame_4.2.3.">4.2.3.Cluster用MBean</a></span>
</dt>
</dl>
</dd>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.3."><a href="#tubame_4.3.">4.3.正規表現</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.4."><a href="#tubame_4.4.">4.4.Session Managerコンフィグレーション</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.5."><a href="#tubame_4.5.">4.5.Session Cookieコンフィグレーション</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="4.6."><a href="#tubame_4.6.">4.6.使用不可となった属性</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="5."><a href="#tubame_5.">5.ディレクトリ構造の変更</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="5.1."><a href="#tubame_5.1.">5.1.sharedライブラリ</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="5.2."><a href="#tubame_5.2.">5.2.Endorsedライブラリ</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="5.3."><a href="#tubame_5.3.">5.3.デフォルトWebアプリケーション</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="5.4."><a href="#tubame_5.4.">5.4.共有Webホスティング環境</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="6."><a href="#tubame_6.">6.添付アプリケーションの変更</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="6.1."><a href="#tubame_6.1.">6.1.Managerアプリケーション</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="6.2."><a href="#tubame_6.2.">6.2.Host Managerアプリケーション</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="7."><a href="#tubame_7.">7.システムプロバティ</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="7.1."><a href="#tubame_7.1.">7.1.システムプロパティ</a></span>
</dt>
</dl>
</dd>
<dt>
<span class="8."><a href="#tubame_8.">8.その他</a></span>
</dt>
<dd>
<dl>
<dt>
<span class="8.1."><a href="#tubame_8.1.">8.1.デプロイメント</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.2."><a href="#tubame_8.2.">8.2.Apache Commons Logging</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.3."><a href="#tubame_8.3.">8.3.Cookies</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.4."><a href="#tubame_8.4.">8.4.XMLバリデーション</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.5."><a href="#tubame_8.5.">8.5.TLD処理</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.6."><a href="#tubame_8.6.">8.6.JSPコンパイラ</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.7."><a href="#tubame_8.7.">8.7.内部API</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.8."><a href="#tubame_8.8.">8.8.changeSessionIdOnAuthentication属性</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.9."><a href="#tubame_8.9.">8.9.Administration Web Application の廃止</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.10."><a href="#tubame_8.10.">8.10.ACTIVITY_CHECKフィールド</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.11."><a href="#tubame_8.11.">8.11.ServletOutputStreamクラス</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.12."><a href="#tubame_8.12.">8.12.アクセスログ</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.13."><a href="#tubame_8.13.">8.13.レルム</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.14."><a href="#tubame_8.14.">8.14.セッションの最終アクセス時間</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.15."><a href="#tubame_8.15.">8.15.ライフサイクルリスナ</a></span>
</dt>
</dl>
</dd>
<dd>
<dl>
<dt>
<span class="8.16."><a href="#tubame_8.16.">8.16.Valve</a></span>
</dt>
</dl>
</dd>
</dl>
</div>
<HR>
<a name="tubame_1."></a>
<h2 class="title">1.JavaSE6必須</h2>
<br>
<a name="tubame_1.1."></a>
<h3 class="title">1.1.JavaSE6必須</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat7.0.xは、JavaSE6以降が必須となる。</p>
</div>
<br>
<br>
<a name="tubame_2."></a>
<h2 class="title">2.JavaEE6必須</h2>
<br>
<a name="tubame_2.1."></a>
<h3 class="title">2.1.仕様サポート</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat7.0.xは、Servlet 3.0、JSP2.2、EL2.2仕様をサポートしている。</p>
</div>
<br>
<br>
<a name="tubame_2.2."></a>
<h3 class="title">2.2.Servlet 3.0 API</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>
    	 ワイルドカード（*）のimport構文を使用するJSPページでは、Servlet APIに追加された新しいクラスとWebアプリケーションに含まれるクラスが競合する可能性がある。
    	 例えば、パッケージ "a" にPartクラスが含まれている場合、次のJSPページはTomcat7でコンパイルできなくなる。
    	 </p>
<p>
         これは、javax.servlet.http.*の暗黙的なimportとa.*の明示的なimportにおいて、Servlet3.0で追加されたPartクラスの定義の競合するために発生する問題である。
        Tomcatは、JSP&rarr;Servletファイル（.java）のコンパイルの際、デフォルトのimportとして"javax.servlet.*"、"javax.servlet.http.*"、"javax.servlet.jsp.*"を設定するため、JSPにおいてワイルドカードのimport文を使用すると、Servlet3.0で追加されたクラスと衝突してしまう。
        </p>
<p>この問題を解決するには、明示的なimport（この例では、import="a.Part"）を利用することである。</p>
</div>
<br>
<br>
<a name="tubame_2.3."></a>
<h3 class="title">2.3.JavaEE非推奨API</h3>
<br>
<br>
<a name="tubame_2.3.1."></a>
<h3 class="title">2.3.1.Servlet非推奨API</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>以下は、Servlet3.0で非推奨となったAPIの一覧であり、これらAPIを利用している場合には、代替となるAPIを利用するように修正する必要がある。</p>
<p>推奨されていないインタフェース</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.http.HttpSessionContext</p>
</li>
<li class="listitem">
<p>javax.servlet.SingleThreadModel</p>
</li>
</ul>
</div>
<p>推奨されていないクラス</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.http.HttpUtils</p>
</li>
</ul>
</div>
<p>推奨されていないメソッド</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.http.HttpServletRequest.isRequestedSessionIdFromUrl()</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletRequestWrapper.isRequestedSessionIdFromUrl()</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponse.encodeRedirectUrl(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponse.encodeUrl(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponse.setStatus(int, String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponseWrapper.encodeRedirectUrl(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponseWrapper.encodeUrl(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpServletResponseWrapper.setStatus(int, String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSession.getSessionContext()</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSession.getValue(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSession.getValueNames()</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSession.putValue(String, Object)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSession.removeValue(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSessionContext.getIds()</p>
</li>
<li class="listitem">
<p>javax.servlet.http.HttpSessionContext.getSession(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletContext.getServlet(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletContext.getServletNames()</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletContext.getServlets()</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletContext.log(Exception, String)</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletRequest.getRealPath(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.ServletRequestWrapper.getRealPath(String)</p>
</li>
<li class="listitem">
<p>javax.servlet.UnavailableException.getServlet()</p>
</li>
</ul>
</div>
<p>推奨されていないコンストラクタ</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.UnavailableException(int, Servlet, String)</p>
</li>
<li class="listitem">
<p>javax.servlet.UnavailableException(Servlet, String)</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_2.3.2."></a>
<h3 class="title">2.3.2.JSP非推奨API</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>以下は、JSP2.2で非推奨となったAPIの一覧であり、これらAPIを利用している場合には、代替となるAPIを利用するように修正する必要がある。</p>
<p>推奨されていないインタフェース</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.jsp.el.FunctionMapper</p>
</li>
<li class="listitem">
<p>javax.servlet.jsp.el.VariableResolver</p>
</li>
</ul>
</div>
<p>推奨されていないクラス</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.jsp.el.Expression</p>
</li>
<li class="listitem">
<p>javax.servlet.jsp.el.ExpressionEvaluator</p>
</li>
</ul>
</div>
<p>推奨されていない例外</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.jsp.el.ELException</p>
</li>
<li class="listitem">
<p>javax.servlet.jsp.el.ELParseException</p>
</li>
</ul>
</div>
<p>推奨されていないフィールド</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_TAG</p>
</li>
</ul>
</div>
<p>推奨されていないメソッド</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>javax.servlet.jsp.JspContext.getExpressionEvaluator()</p>
</li>
<li class="listitem">
<p>javax.servlet.jsp.JspContext.getVariableResolver()</p>
</li>
<li class="listitem">
<p>javax.servlet.jsp.JspContext.getRootCause()</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_2.3.3."></a>
<h3 class="title">2.3.3.Servlet、JSP以外の非推奨API</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet、JSP以外にも、JAXB、JSF、EJB、JCAなどで非推奨となっているAPIを利用している場合も、代替となるAPIを利用するように修正する必要がある。</p>
<p>詳細は下記URLを参照のこと。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>http://docs.oracle.com/javaee/6/api/</p>
</li>
<li class="listitem">
<p>http://docs.oracle.com/javaee/6/api/deprecated-list.html</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_3."></a>
<h2 class="title">3.Servlet仕様への対応</h2>
<br>
<a name="tubame_3.1."></a>
<h3 class="title">3.1.Request属性</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet仕様において、標準Request属性javax.servlet.request.ssl_session_idが新しく定義されたため、SSLセッションIDにアクセスするために提供されているカスタムRequest属性javax.servlet.request.ssl_sessionは廃止となった。</p>
<p>このカスタム属性は、Tomcat8で削除される予定である。</p>
</div>
<br>
<br>
<a name="tubame_3.2."></a>
<h3 class="title">3.2.conf/web.xmlファイル処理</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet3.0仕様では、Webフラグメントおよびアノテーションからどのようにアプリケーションのweb.xmlファイルを組合わせることができるかを定義する。</p>
<p>それらの規則を実装した結果、（サーバ全体に渡るデフォルトを定義するグローバルな）conf/web.xmlファイルの処理は変更された。</p>
<p>ひとつ顕著な違いとしては、conf/web.xmlに定義されているFilterではなく、Webアプリケーションに定義されているものに従うといったものである。</p>
</div>
<br>
<br>
<a name="tubame_3.3."></a>
<h3 class="title">3.3.Welcomeファイル処理</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet3.0仕様において、welcomeファイルに対する処理が変更され、Context要素のresourceOnlyServlets属性が追加された。</p>
</div>
<br>
<br>
<a name="tubame_3.4."></a>
<h3 class="title">3.4.アノテーション・スキャン</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet3.0仕様にて必要となるアノテーション・スキャンは、Webアプリケーションの起動時間に影響を与えるだけでなく、スキャンされるクラスをロードするために多くのメモリ容量が必要となる可能性がある。</p>
<p>この問題に対する対処策はいくつか存在する。推奨される方法の一つは、WebアプリケーションのWEB-INF/web.xmlにおいて次の手順を実施することにより、アノテーション・スキャンを必要としないアプリケーションをマークすることである。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>Webアプリケーションがバージョン3.0仕様にしたがっていることを示すために、web-app要素を更新する</p>
<p>デフォルトのconf/web.xmlからversion、xsi:schemaLocation、xmlns、xmlns:xsi属性の値をコピーする</p>
</li>
<li class="listitem">
<p>web-app要素に、属性metadata-complete="true"を追加</p>
</li>
<li class="listitem">
<p>空の&lt;absolute-ordering /&gt;要素を追加</p>
</li>
</ul>
</div>
<p>２つめの方法は、特定のJARファイルを無視するように、JarScannerコンポーネントを設定することである。通常、tomcat.util.scan.DefaultJarScanner.jarsToSkipシステムプロパティは、conf/catalina.propertiesファイルに設定する。</p>
</div>
<br>
<br>
<a name="tubame_4."></a>
<h2 class="title">4.コンフィギュレーションの変更</h2>
<br>
<a name="tubame_4.1."></a>
<h3 class="title">4.1.Connectorの仕様変更</h3>
<br>
<br>
<a name="tubame_4.1.1."></a>
<h3 class="title">4.1.1.SSL設定</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>全てのSSLを有効にするConnectorの場合、SSLEnabledフラグにtrueを設定しなければならない。</p>
<pre class="programlisting">
        &lt;Connector ...
            SSLEnabled="true"
              ... /&gt;
        </pre>
<p>Tomcat単体でSSL通信を行う場合、上記設定が必要となる。Apacheと連携してTomcatを動かす場合、ApacheにてSSL通信を行うため、Tomcatでの設定は不要となる。</p>
</div>
<br>
<br>
<a name="tubame_4.1.2."></a>
<h3 class="title">4.1.2.スレッドプール</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Connectorスレッドプールは簡素化され、指定された最大値まで大きくなるが、小さくなることはない。（minSpareThreads属性など、スレッドプールの減少に関連付けられた属性は無視される。）</p>
<p>リクエストが増減するスレッドプールを必要とする場合、Executorを設定したり、それを使うためにConnectorを設定する必要がある。</p>
<p>参考URL</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>http://tomcat.apache.org/tomcat-6.0-doc/config/executor.html</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_4.1.3."></a>
<h3 class="title">4.1.3.コネクタとスレッドプール</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>コネクタの実装をリファクタリングにより統一された実装とし、また、独自のスレッドプールからの実装からjava標準のExecutorベースのスレッドプールに変更された。</p>
<p>その結果、以下のような変更があり注意が必要である。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>コネクタの設定からmaxSpareThreads属性が削除された</p>
</li>
<li class="listitem">
<p>スレッドプールを参照するためのObjectNameも変更された</p>
<p>具体的には、Tomcat7からnameが(ajp/http)-(bio/nio/apr)+encodedAddr+endpoint.getPort()となった</p>
</li>
<li class="listitem">
<p>各コネクタでLogfullメッセージも出力されない</p>
</li>
<li class="listitem">
<p>AJPコネクタは、registerRequests属性が無効となった</p>
</li>
</ul>
</div>
<p>また、特にjk系のパッケージは全て削除されたため、今までのJKコネクタとはまったく異なる実装となっており、以前のノウハウは利用できないものが多くなった。</p>
</div>
<br>
<br>
<a name="tubame_4.2."></a>
<h3 class="title">4.2.クラスタリングのコンフィグレーションの変更</h3>
<br>
<br>
<a name="tubame_4.2.1."></a>
<h3 class="title">4.2.1.クラスタリング構成のサーバ設定</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>クラスタリングの構成はリファクタリングされた。クラスタを設定するにあたり、Tomcat5.5.xとTomcat7.0.xでserver.xmlで使用されるタグと属性の変更点と対応付けを以下に示す。</p>
<div class="table">
<a name="N12C6B"></a>
<p class="title">
<b>Table&nbsp;1.&nbsp;server.xmlのクラスタに関する変更点</b>
</p>
<div class="table-contents">
<table summary="server.xmlのクラスタに関する変更点" border="1">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td>Tomcat5.5.x</td><td>Tomcat7.0.x</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Membership&gt; mcastAddr</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Membership&gt; address</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Membership&gt; mcastPort</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Membership&gt; port</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Membership&gt; mcastFrequecy</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Membership&gt; frequency</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Membership&gt; mcastDropTime</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Membership&gt; dropTime</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Reciever&gt; tcpListenerAddress</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Reciever&gt; address</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Reciever&gt; tcpListenerPort</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Reciever&gt; port</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Reciever&gt; tcpSelectorTimeout</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Reciever&gt; selectorTimeout</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Sender&gt; replicationMode</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Cluster&gt; channelSendOptions</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Sender&gt; waitForAck</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Cluster&gt; channelSendOptions</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Sender&gt; resend</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Sender&gt; &lt;Transport&gt; maxRetryAttempts</td>
</tr>
<tr>
<td>&lt;Cluster&gt; &lt;Sender&gt; maxPoolSocketLimit</td><td>&lt;Cluster&gt; &lt;Channel&gt; &lt;Sender&gt; &lt;Transport&gt; PoolSize</td>
</tr>
</tbody>
</table>
</div>
</div>
<br class="table-break">
<p>下記の属性は非推奨。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>&lt;Cluster&gt; doClusterLog</p>
</li>
<li class="listitem">
<p>&lt;Cluster&gt; clusterLogName</p>
</li>
<li class="listitem">
<p>&lt;Cluster&gt; &lt;Manager&gt; defaultMode</p>
</li>
<li class="listitem">
<p>&lt;Cluster&gt; &lt;Manager&gt; domainReplication</p>
<p>この属性は、DomainFilterInterceptorに代替され、以下のように設定する。</p>
<pre class="programlisting">
                &lt;Channel className="..." ... &gt;
                    ...
                  &lt;Interceptor
                    className="org.apache.catalina.tribes.group.interceptors.DomainFilterInterceptor"
                    domain="..."
                    ...
                &lt;/Channel&gt;
                </pre>
</li>
</ul>
</div>
<p>参考URL</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>http://tomcat.apache.org/tomcat-7.0-doc/config/cluster.html</p>
</li>
<li class="listitem">
<p>http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_4.2.2."></a>
<h3 class="title">4.2.2.ThroughputInterceptor</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat5.5.xでは、セッションレプリケーションの送受信の統計情報をデフォルトで出力していたが、Tomcat7.0.xではデフォルトでは出力しない。出力する場合には、server.xmlに以下のように設定する必要がある。</p>
<pre class="programlisting">
        &lt;Channel className="..." ...&gt;
           ...
          &lt;Interceptor
            className="org.apache.catalina.trivbes.group.interceptors.ThroughputInterceptor"
           ...
        &lt;/Channel&gt;
        </pre>
</div>
<br>
<br>
<a name="tubame_4.2.3."></a>
<h3 class="title">4.2.3.Cluster用MBean</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat6.0.x以降、Cluster関係のMBeanを参照することができなくなった。</p>
</div>
<br>
<br>
<a name="tubame_4.3."></a>
<h3 class="title">4.3.正規表現</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>正規表現を使用するすべての設定オプションは、コンマあるいはセミコロン区切りのリストではなく、（java.util.regexを利用する）単一の正規表現を指定する必要がある。</p>
<p>以下の属性が関係するため、正規表現を見直す必要がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>RemoteAddrFilter、RemoteHostFilter、RemoteAddrValve、RemoteHostValveのallow属性とdeny属性</p>
</li>
<li class="listitem">
<p>RemoteIpFilter、RemoteIpValveのinternalProxies属性とtrustedProxies属性</p>
</li>
<li class="listitem">
<p>ReplicationValveのfilter属性</p>
</li>
<li class="listitem">
<p>HTTP ConnectorsのrestrictedUserAgents属性とnoCompressionUserAgents属性</p>
</li>
</ul>
</div>
<p>また、"|"演算子を用いて、別々の正規表現を連結することができることに注意すること。</p>
</div>
<br>
<br>
<a name="tubame_4.4."></a>
<h3 class="title">4.4.Session Managerコンフィグレーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>セッションの生成や破棄のパフォーマンスを改善するために、セッションID作成に対する変更など、Session Managerに対して多くの変更が実施された。</p>
<p>コンフィグレーションの変更点は、以下のとおり。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>ManagerのrandomClass属性は、secureRandomClassに変更。提供されるクラスは、java.secure.SecureRandomを拡張する必要がある</p>
</li>
<li class="listitem">
<p>追加されたsecureRandomAlgorithm属性とsecureRandomProvider属性は、SecureRandom実装の選択を可能とする</p>
</li>
<li class="listitem">
<p>algorithm属性、entropy属性は削除</p>
</li>
</ul>
</div>
<p>セッションID作成処理が大幅に変更となったため、旧バージョンとの互換性がなくなり、上記設定を行っているユーザは、設定ファイルの変更が必須となる。</p>
</div>
<br>
<br>
<a name="tubame_4.5."></a>
<h3 class="title">4.5.Session Cookieコンフィグレーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Servlet 3.0仕様におけるSessionCookieConfigの追加により、コンフィグレーションおよびコードの複雑さを軽減するために、多くのSession Cookie設定オプションは削除された。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>ConnectorのemptySessionPath属性は削除。$CATALINA_BASE/conf/context.xmlにおいて、sessionCookiePath="/"を設定することによって、同等の効果が得られる</p>
</li>
<li class="listitem">
<p>org.apache.catalina.SESSION_COOKIE_NAME システムプロパティは削除。$CATALINA_BASE/conf/context.xmlにおいて、sessionCookieName属性を設定することによって、同等の効果が得られる</p>
</li>
<li class="listitem">
<p>org.apache.catalina.SESSION_PARAMETER_NAME システムプロパティは削除。$CATALINA_BASE/conf/context.xmlにおいて、sessionCookieName属性を設定することによって、同等の効果が得られる</p>
</li>
<li class="listitem">
<p>ContextのdisableURLRewriting属性は削除。Webアプリケーションあるいは$CATALINA_BASE/conf/web.xmlにおいて、session-config/tracking-mode要素を設定することによって、同等の効果が得られる</p>
</li>
</ul>
</div>
<p>Tomcat7のセッションおよびSSO Cookieは、JavaScriptからのアクセスを防ぐために、デフォルトでHttpOnlyフラグで送信されてくる。この機能は、Context要素のuseHttpOnly属性によって制御することができる。</p>
<p>（この機能は、Tomcat6.0の最新バージョンでは、デフォルトでオフとなっているため、有効にするには、Webアプリケーションあるいは$CATALINA_BASE/conf/web.xmlのContext要素のuseHttpOnly属性にtrueを設定すればよい。）</p>
</div>
<br>
<br>
<a name="tubame_4.6."></a>
<h3 class="title">4.6.使用不可となった属性</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>設定ファイルで使用不可となった属性を以下に示す。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>Connectorのstrategy属性</p>
</li>
<li class="listitem">
<p>LoaderのuseSystemClassLoaderAsParent属性</p>
<p>LoaderのAPIが変更され、親のクラスローダが常に関連付けられたコンテナから取得しているため、Tomcat7.0.xでは存在しない。</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_5."></a>
<h2 class="title">5.ディレクトリ構造の変更</h2>
<br>
<a name="tubame_5.1."></a>
<h3 class="title">5.1.sharedライブラリ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat6.0.x以降、Tomcat5.5.xで使用していたcommon、shared、serverサブディレクトリがなくなり、単一のlibディレクトリとなった。</p>
<p>Tomcatは$CATALINA_BASE/libディレクトリと$CATALINA_HOME/libディレクトリの両方をサポートし、$CATALINA_BASE/libディレクトリ内のJARファイルとclassファイルは、CLASSPATHよりも優先される。</p>
<p>●クラスローダ</p>
<p>ディレクトリ構造の変更の結果として、common、shared、serverクラスタローダは一つのクラスローダにマージされた。実際、shared、serverクラスローダはデフォルトで設定されず、commonクラスローダはlibディレクトリにマッピングされている。</p>
<p>この動作と構造は、conf/catalina.propertiesファイルを用いて変更することができる。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>Tomcat5.5.xでcommon/lib、shared/lib、server/libディレクトリにjarファイルを配置して使用していた場合、Tomcat7.0.xのlibディレクトリにそれらを配置する必要がある。classファイルも同様。</p>
</li>
<li class="listitem">
<p>Tomcat5.5.xのwebappsディレクトリに配置している独自のWebアプリケーションは、そのままTomcat7.0.xのwebappsディレクトリに移動する。</p>
</li>
<li class="listitem">
<p>Tomcat5.5.xと同じディレクトリ構造でTomcat6.0.xを使用する場合、conf/catalina.propertiesファイルの"common.loader"、"server.loader"、"shared.loader"にそれぞれ設定する必要がある。設定例は以下のとおり。</p>
<pre class="programlisting">
                shared.loader=${catalina_base}/shared/classes,${catalina_base}/shared/lib/*.jar,
                ${catalina_home}/shared/classes,${catalina_home}/shared/lib/*.jar
                </pre>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_5.2."></a>
<h3 class="title">5.2.Endorsedライブラリ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>$CATALINA_HOME/common/endorsedサブディレクトリは、$CATALINA_HOME/endorsedディレクトリに置換される。</p>
<p>ただし、このディレクトリはデフォルトでは存在しない。代わりのディレクトリを指定するための環境変数JAVA_ENDORSED_DIRは、setenv.batあるいはsetenv.shを使用することで設定できる。</p>
</div>
<br>
<br>
<a name="tubame_5.3."></a>
<h3 class="title">5.3.デフォルトWebアプリケーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>ManagerとHostManagerのWebアプリケーションは、server/webapps内には存在せず、全てのデフォルトのWebアプリケーションは、webappsディレクトリに配置される。</p>
<p>HostのdeployOnStartupやautoDeployのオプションが許可されている場合、ManagerとHostManagerアプリケーションのMETA-INF/context.xmlファイルは、最初のTomcat起動時に、$CATALINA_BASE/conf/[engine_name]/[host_name]ディレクトリ内にコピーされることに注意すること。</p>
</div>
<br>
<br>
<a name="tubame_5.4."></a>
<h3 class="title">5.4.共有Webホスティング環境</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>共有のWebホスティング環境を使用するとき、Webアプリケーション内のcontext.xmlの使用を禁止することを推奨する。</p>
</div>
<br>
<br>
<a name="tubame_6."></a>
<h2 class="title">6.添付アプリケーションの変更</h2>
<br>
<a name="tubame_6.1."></a>
<h3 class="title">6.1.Managerアプリケーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Managerアプリケーションは、Tomcat7以降では再構成されており、いくつかのURLが変更されている。Managerアプリケーションへのアクセスに使用されるすべてのURLは、次のオプションのいずれかで始まる必要がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>&lt;ContextPath&gt;/html（HTML GUI）</p>
</li>
<li class="listitem">
<p>&lt;ContextPath&gt;/text（テキストインタフェース）</p>
</li>
<li class="listitem">
<p>&lt;ContextPath&gt;/jmxproxy（JMXプロキシ）</p>
</li>
<li class="listitem">
<p>&lt;ContextPath&gt;/status（statusページ）</p>
</li>
</ul>
</div>
<p>特に、テキストインタフェースのURLが、&lt;ContextPath&gt;/textに変更されていることに注意すること。</p>
<p>Managerアプリケーションを利用するために必要なロールは、単一のmanagerロールから次の4つのロールに変更され、アクセスしたい機能に必要なロールを割り当てる必要がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>manager-gui：HTML GUIとstatusページへのアクセスを許可</p>
</li>
<li class="listitem">
<p>manager-script：テキストインタフェースとstatusページへのアクセスを許可</p>
</li>
<li class="listitem">
<p>manager-jmx：JMXプロキシとstatusページへのアクセスを許可</p>
</li>
<li class="listitem">
<p>manager-status：statusページへのアクセスのみ許可</p>
</li>
</ul>
</div>
<p>HTMLインタフェースは、CSRF（Cross Site Request Forgeries）に対して保護されているが、テキストインタフェースとJMXインタフェースは保護されていない。</p>
<p>CSRFに対して保護するために、</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>manager-guiロールが付与されているユーザには、manager-scriptあるいはmanager-jmxロールを付与しない</p>
</li>
<li class="listitem">
<p>Managerアプリケーションがmanager-scriptあるいはmanager-jmxロールが付与されているユーザからブラウザでアクセスされた場合には、
                セッションを終了させるために後でブラウザの全てのウィンドウを閉じる必要がある。</p>
</li>
</ul>
</div>
<p>rolesコマンドは、デフォルト設定では動作しないことと、ほとんどのレルムがロールリストのサポートをしていないため、Managerアプリケーションから削除された。HTMLインタフェースは、CSRF（Cross Site Request Forgeries）に対して保護されているが、テキストインタフェースとJMXインタフェースは保護されていない。</p>
</div>
<br>
<br>
<a name="tubame_6.2."></a>
<h3 class="title">6.2.Host Managerアプリケーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Host Managerアプリケーションは、Tomcat7以降では再構成されており、いくつかのURLが変更されている。Host Managerアプリケーションへのアクセスに使用されるすべてのURLは、次のオプションのいずれかで始まる必要がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>&lt;ContextPath&gt;/html（HTML GUI）</p>
</li>
<li class="listitem">
<p>&lt;ContextPath&gt;/text（テキストインタフェース）</p>
</li>
</ul>
</div>
<p>特に、テキストインタフェースのURLが、&lt;ContextPath&gt;/textに変更されていることに注意すること。</p>
<p>Host Managerアプリケーションを利用するために必要なロールが、単一のadminロールから次の2つのロールに変更され、アクセスしたい機能に必要なロールを割り当てる必要がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>admin-gui：HTML GUIとstatusページへのアクセスを許可</p>
</li>
<li class="listitem">
<p>admin-script：テキストインタフェースとstatusページへのアクセスを許可</p>
</li>
</ul>
</div>
<p>HTMLインタフェースは、CSRFに対して保護されているが、テキストインタフェースとJMXインタフェースは保護されていない。</p>
<p>CSRFに対して保護するために、</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>admin-guiロールが付与されているユーザには、admin-scriptロールを付与しない</p>
</li>
<li class="listitem">
<p>Host Managerアプリケーションがadmin-scriptロールが付与されているユーザからブラウザでアクセスされた場合には、
                セッションを終了させるために後でブラウザの全てのウィンドウを閉じる必要がある。</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_7."></a>
<h2 class="title">7.システムプロバティ</h2>
<br>
<a name="tubame_7.1."></a>
<h3 class="title">7.1.システムプロパティ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat6.0では、org.apache.catalina.STRICT_SERVLET_COMPLIANCEシステムプロパティによって、統一的に仕様制約を制御していた。
        ただし、それでは柔軟な設定ができないということで、Tomcat7.0では、org.apache.catalina.STRICT_SERVLET_COMPLIANCEシステムプロパティで
        デフォルト値を設定し、仕様制約ごとのシステムプロパティや設定で上書きできるように変更された。</p>
<p>Tomcat7.0で、org.apache.catalina.STRICT_SERVLET_COMPLIANCEシステムプロパティがデフォルトを設定する制約は、以下のとおり。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>org.apache.catalina.core.ApplicationContext.GET_RESOURCE_REQUIRE_SLASH</p>
</li>
<li class="listitem">
<p>org.apache.catalina.core.ApplicationDispatcher.WRAP_SAME_OBJECT</p>
</li>
<li class="listitem">
<p>org.apache.catalina.core.StandardHostValve.ACCESS_SESSION</p>
</li>
<li class="listitem">
<p>org.apache.catalina.session.StandardSession.ACTIVITY_CHECK</p>
</li>
<li class="listitem">
<p>org.apache.catalina.session.StandardSession.LAST_ACCESS_AT_START</p>
</li>
<li class="listitem">
<p>org.apache.tomcat.util.http.ServerCookie.ALWAYS_ADD_EXPIRES</p>
</li>
<li class="listitem">
<p>org.apache.tomcat.util.http.ServerCookie.FWD_SLASH_OS_SEPARATOR</p>
</li>
<li class="listitem">
<p>org.apache.tomcat.util.http.ServerCookie.STRICT_NAMING</p>
</li>
<li class="listitem">
<p>Context要素のresourceOnlyServlets属性</p>
</li>
<li class="listitem">
<p>Context要素のtldNamespaceAware属性</p>
</li>
<li class="listitem">
<p>Context要素のtldValidation属性</p>
</li>
<li class="listitem">
<p>Context要素のxmlNamespaceAware属性</p>
</li>
<li class="listitem">
<p>Context要素のxmlValidation属性</p>
</li>
</ul>
</div>
<p>org.apache.coyote.MAX_TRAILER_SIZEシステムプロパティは削除され、Connector要素のmaxTrailerSize属性によって置き換えられる。</p>
</div>
<br>
<br>
<a name="tubame_8."></a>
<h2 class="title">8.その他</h2>
<br>
<a name="tubame_8.1."></a>
<h3 class="title">8.1.デプロイメント</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>
        Tomcat7において、Hostに追加されたxmlBase属性、copyXML属性によって、デフォルトの動作が変更されたので注意が必要となる。
        </p>
<p>xmlBase属性によって、Hostのコンフィグレーションファイルの配置場所が変更可能。デフォルトは未設定で、Tomcat6と同様$CATALINA_BASE/conf/Engine名/Host名となる。</p>
<p>copy属性によって、XMLコンテキストディスクリプタ（META-INF/context.xml）をxmlBaseにコピーするかどうかを決定。デフォルトはfalseで、デプロイしたWARファイルやディレクトリからcontext.xmlはコピーされない。</p>
<p>したがって、Tomcat6&rarr;Tomcat7へのバージョンアップで、META-INF/context.xmlの取扱いが変更されたこととなる。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>Tomcat6では、META-INF/context.xmlを$CATALINA_BASE/conf/Engine名/Host名に"コンテキスト名".xmlとしてコピーし、リデプロイのチェック対象は、"コンテキスト名".xmlとなる。</p>
</li>
<li class="listitem">
<p>Tomcat7では、META-INF/context.xmlをパースだけしコピーはしない。リデプロイのチェック対象は、META-INF/context.xmlとなる。</p>
</li>
</ul>
</div>
<p>Tomcat6のデフォルトの振る舞いにするには、HostのcopyXML属性にtrueを設定することで有効にすることができる。</p>
</div>
<br>
<br>
<a name="tubame_8.2."></a>
<h3 class="title">8.2.Apache Commons Logging</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat5.5.xでは、Commons Logging を使用していたが、Tomcat7.0.xでは、JULIを直接使用している。</p>
<p>WebアプリケーションにLog4jを使用する場合、Tomcat5.5.xではそのアプリケーションのServletログやContextに関するログもLog4jの設定にしたがって出力されるが、Tomcat7.0.xではこれらのログはJULIの設定にしたがう。つまりバージョン間でログの出力範囲が異なっていることに注意が必要。</p>
<p>参考URL</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>http://tomcat.apache.org/tomcat-6.0-doc/logging.html</p>
</li>
<li class="listitem">
<p>http://tomcat.apache.org/tomcat-6.0-doc/extras.html</p>
</li>
</ul>
</div>
<p>●commons-logging.jar</p>
<p>commons-logging-api-jarライブラリは、Webアプリケーション用に提供されないため、Apache Commons Loggingを使用しているWebアプリケーションは、そのライブラリ独自のコピーを提供する必要がある。</p>
<p>他のjarファイルと同様に、WEB-INF/libディレクトリにそれを配置することが推奨される。</p>
</div>
<br>
<br>
<a name="tubame_8.3."></a>
<h3 class="title">8.3.Cookies</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcatは、デフォルトで、仕様に準拠しない名前のみのCookieを受け入れなくなった。</p>
<p>ただし、新しくorg.apache.tomcat.util.http.ServerCookie.ALLOW_NAME_ONLYシステムプロパティが追加され、名前のみのCookieを受け入れるようにすることができる。</p>
</div>
<br>
<br>
<a name="tubame_8.4."></a>
<h3 class="title">8.4.XMLバリデーション</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>XMLバリデーションの構成が簡素化され、xmlValidationとxmlNamespaceAware属性は、Host要素から削除された。</p>
<p>これらの属性は、tldValidationとtldNamespaceAware属性とともに、Context要素ごとに設定される。デフォルト値は、各属性とも変更されておらず、falseである。</p>
</div>
<br>
<br>
<a name="tubame_8.5."></a>
<h3 class="title">8.5.TLD処理</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>TLD処理については、一貫性の改善を重複の排除といった内部のリファクタリングに加えて、いくつかの機能改善がある。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>タグファイル内のEL処理は、タグファイルに宣言されているJSPのバージョンと一致する</p>
</li>
<li class="listitem">
<p>TLDファイルをWEB-INF/libあるいはWEB-INF/classesディレクトリに配置することは許可されていない</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_8.6."></a>
<h3 class="title">8.6.JSPコンパイラ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>JspServletの初期化パラメータが、genStrAsCharArrayからgenStringAsCharArrayに変更された。</p>
</div>
<br>
<br>
<a name="tubame_8.7."></a>
<h3 class="title">8.7.内部API</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat7の内部APIが、Tomcat6と広く互換性をもっている一方、詳細レベルに多くの変更がありバイナリ互換ではない。</p>
<p>Tomcat内部APIを利用しているカスタムコンポーネントについては、関連するAPIのJavaDocを確認する必要がある。特に注目すべき点は以下のとおり。</p>
<div class="itemizedlist">
<ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p>すべてのコンポーネントが拡張するLifecycleインタフェースの標準実装</p>
</li>
<li class="listitem">
<p>genericsの利用</p>
</li>
<li class="listitem">
<p>Host内のContextのためのユニークな識別子として、Contextパスではなく、Context名を利用</p>
</li>
</ul>
</div>
</div>
<br>
<br>
<a name="tubame_8.8."></a>
<h3 class="title">8.8.changeSessionIdOnAuthentication属性</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcatの認証機能を使用している場合、changeSessionIdOnAuthentication属性のデフォルト値が変更されて、Tomcat5.5.xではfalseであったが、Tomcat6.0.x以降ではtrueとなっている。</p>
<p>Tomcat6.0.x以降でこの属性を無効にする場合（Tomcat5.5.xと同様の動作にする場合）、changeSessionIdOnAuthentication属性を設定する必要がある。</p>
<pre class="programlisting">
        &lt;Valve className="..."
         ...
          changeSessionIdOnAuthentication=&amp;quot;false&amp;quot;
         ... /&gt;
        </pre>
</div>
<br>
<br>
<a name="tubame_8.9."></a>
<h3 class="title">8.9.Administration Web Application の廃止</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat6.0以降、Administration Web Applicationは廃止され、そのアプリケーションによる変更を検知する役割を持っていたStoreConfigLifecycleListenerも使用することができなくなった。</p>
</div>
<br>
<br>
<a name="tubame_8.10."></a>
<h3 class="title">8.10.ACTIVITY_CHECKフィールド</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcatがリクエストの処理を行っている間、セッションの破棄がされないようにするには、conf/catalina.propertiesにおいて、ACTIVITY_CHECKをtrueに設定する必要がある。</p>
<pre class="programlisting">
        org.apache.catalina.session.StandardSession.ACTIVITY_CHECK=true
        </pre>
</div>
<br>
<br>
<a name="tubame_8.11."></a>
<h3 class="title">8.11.ServletOutputStreamクラス</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>Tomcat6.0以降、ServletOutputStreamクラスのprint(String s)メソッドを使用している場合、パラメータの文字列にISO 8859-1以外が設定されるとCharConversionExceptionが発生する。</p>
<p>ISO 8859-1以外が設定されても例外が発生しないようにするためには以下の実装方法とすることで対応可能である。</p>
<p>-----------------------------------------</p>
<p>PrintWriter pw = response.getWriter();</p>
<p>pw.print(string);</p>
<p>-----------------------------------------</p>
</div>
<br>
<br>
<a name="tubame_8.12."></a>
<h3 class="title">8.12.アクセスログ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>デフォルトで無効から有効に変更され、server.xmlに指定されているログフォーマットもcommonから"%h %l %u %t "%r" %s %b"に変更された。</p>
</div>
<br>
<br>
<a name="tubame_8.13."></a>
<h3 class="title">8.13.レルム</h3>
<br>
<div class="section">
<div class="titlepage">
<div>
<div>
<h2 class="title" style="clear: both">
<a name="N12F0D"></a>1.&nbsp;レルム</h2>
</div>
</div>
</div>
<p>Tomcat7.0では、デフォルトで、LockOutRealmが有効に設定されているため、認証失敗の回数に制限がかかる。</p>
</div>
<br>
<br>
<a name="tubame_8.14."></a>
<h3 class="title">8.14.セッションの最終アクセス時間</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>LAST_ACCESS_AT_STARTシステムプロパティの追加により、セッションの最終アクセス時間とアイドル時間の算出方法が変更となった。</p>
<p>最終アクセス時間は、LAST_ACCESS_AT_STARTがtrueならば、前のリクエストの開始から計算され、falseならば、前のリクエストの終了から計算される。</p>
<p>セッションタイムアウトをチェックするためのセッションアイドル時間は、以下のように算出される。</p>
<div class="table">
<a name="N12F22"></a>
<p class="title">
<b>Table&nbsp;1.&nbsp;Tomcat7.0とTomcat6.0のセッションアイドル時間の計算方法</b>
</p>
<div class="table-contents">
<table summary="Tomcat7.0とTomcat6.0のセッションアイドル時間の計算方法" border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td>&nbsp;</td><td>7.0.x (LAST_ACCESS_AT_START=true)</td><td>7.0.x (LAST_ACCESS_AT_START=false)</td><td>6.0.x</td>
</tr>
<tr>
<td>アクセス開始</td><td>thisAccessTimeにカレントタイムを設定</td><td>thisAccessTimeにカレントタイムを設定</td><td>lastAccessTimeにthisAcccessTime（前回アクセス開始時間）を設定し、thisAccessTimeにカレントタイムを設定</td>
</tr>
<tr>
<td>アクセス終了</td><td>lastAccessTimeにthisAcccessTime（今回アクセス開始時間）を設定し、thisAccessTimeにカレントタイムを設定</td><td>lastAccessTimeとthisAccessTimeにカレントタイムを設定</td><td>NOP</td>
</tr>
<tr>
<td>セッションアイドル時間の算出</td><td>lastAccessTimeからの経過時間</td><td>thisAccessTimeからの経過時間</td><td>thisAccessTimeからの経過時間</td>
</tr>
</tbody>
</table>
</div>
</div>
<br class="table-break">
</div>
<br>
<br>
<a name="tubame_8.15."></a>
<h3 class="title">8.15.ライフサイクルリスナ</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>org.apache.catalina.mbeans.ServerLifecycleListenerが、ライフサイクルのリファクタリングによって不要となったため、削除された。</p>
<p>Tomcat5.5では、デフォルトでserver.xmlに設定されているため、server.xmlをそのまま利用することができない。</p>
</div>
<br>
<br>
<a name="tubame_8.16."></a>
<h3 class="title">8.16.Valve</h3>
<br>
<div class="section">
<div class="titlepage"></div>
<p>RequestDumperValveとWebdavFixValveは削除され、代わりにorg.apache.catalina.filtersパッケージのFilterとして実装された。そのため、設定ファイルもserver.xml(context.xml)からweb.xmlに変更となる。</p>
<p>FastCommonAccessLogValveが削除された。</p>
</div>
<br>
<br>
</BODY>
</HTML>
